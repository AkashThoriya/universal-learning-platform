import { useState } from 'react';
import { 
  Sparkles, 
  AlertTriangle, 
  Code, 
  FileText, 
  CheckCircle,
  ExternalLink,
  BookOpen,
  Info
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { MarkdownEditor } from '@/components/ui/markdown-editor';
import { SyllabusTopic, TopicProgress } from '@/types/exam';
import { cn } from '@/lib/utils/utils';

interface TopicContentTabsProps {
  topic: SyllabusTopic;
  progress: TopicProgress | null;
  userNotes: string;
  saving?: boolean;
  onNotesChange: (value: string) => void;
  onSaveNotes: () => void;
  onToggleQuestion: (slug: string, link?: string, name?: string) => void;
}

export function TopicContentTabs({
  topic,
  progress,
  userNotes,
  saving,
  onNotesChange,
  onSaveNotes,
  onToggleQuestion
}: TopicContentTabsProps) {
  const [activeTab, setActiveTab] = useState('overview');

  return (
    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-visible min-h-[60vh]">
      <Tabs defaultValue="overview" value={activeTab} onValueChange={setActiveTab} className="w-full">
        {/* Apple-style Tabs List */}
        <div className="border-b border-slate-100 px-2 sm:px-6 sticky top-0 bg-white/95 backdrop-blur z-20 rounded-t-2xl">
          <TabsList className="h-14 bg-transparent p-0 gap-6 sm:gap-8 overflow-x-auto w-full justify-start no-scrollbar relative">
            <TabTriggerItem value="overview" icon={<BookOpen size={18} />} label="Overview" />
            <TabTriggerItem value="concepts" icon={<Sparkles size={18} />} label="Key Concepts" />
            <TabTriggerItem value="practice" icon={<Code size={18} />} label="Practice" count={topic.practiceQuestions?.length} />
            <TabTriggerItem value="notes" icon={<FileText size={18} />} label="Notes" />
          </TabsList>
        </div>

        {/* Tab Content Area - with padding */}
        <div className="p-4 sm:p-6 lg:p-8">
          
          {/* Overview Tab */}
          <TabsContent value="overview" className="mt-0 space-y-8 animate-in fade-in-50 slide-in-from-bottom-2 duration-300">
            {/* Description */}
            <div className="prose prose-slate max-w-none">
              <h3 className="text-xl font-semibold text-slate-900 mb-4">Introduction</h3>
              <p className="text-slate-600 leading-relaxed text-lg">
                {topic.description || "No description available for this topic yet."}
              </p>
            </div>

            {/* Pro Tips */}
            {topic.learningTip && topic.learningTip.length > 0 && (
              <div className="bg-indigo-50/50 rounded-xl p-6 border border-indigo-100">
               <h3 className="text-lg font-semibold text-indigo-900 mb-4 flex items-center gap-2">
                 <Sparkles className="h-5 w-5 text-indigo-600" />
                 Pro Tips & Strategy
               </h3>
               <ul className="space-y-4">
                 {topic.learningTip.map((tip, idx) => (
                   <li key={idx} className="flex gap-4 items-start">
                     <span className="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold mt-0.5">
                       {idx + 1}
                     </span>
                     <span className="text-slate-700 leading-relaxed">{tip}</span>
                   </li>
                 ))}
               </ul>
              </div>
            )}
          </TabsContent>

          {/* Concepts Tab */}
          <TabsContent value="concepts" className="mt-0 space-y-6 animate-in fade-in-50 slide-in-from-bottom-2 duration-300">
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                 <h3 className="text-xl font-semibold text-slate-900">Must-Know Concepts</h3>
                 <Badge variant="outline" className="text-slate-500">
                   {topic.mustNotMiss?.length || 0} Points
                 </Badge>
              </div>
              
              {topic.mustNotMiss && topic.mustNotMiss.length > 0 ? (
                <div className="grid gap-4">
                  {topic.mustNotMiss.map((concept, idx) => (
                    <Card key={idx} className="border-l-4 border-l-amber-400 border-y border-r border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                      <CardContent className="p-4 flex gap-4">
                        <AlertTriangle className="h-5 w-5 text-amber-500 flex-shrink-0 mt-1" />
                        <p className="text-slate-800 font-medium leading-relaxed">{concept}</p>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              ) : (
                <div className="text-center py-12 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                  <Info className="h-10 w-10 mx-auto mb-2 opacity-50" />
                  <p>No key concepts listed yet.</p>
                </div>
              )}
            </div>
          </TabsContent>

          {/* Practice Tab */}
          <TabsContent value="practice" className="mt-0 space-y-6 animate-in fade-in-50 slide-in-from-bottom-2 duration-300">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-xl font-semibold text-slate-900">Practice Problems</h3>
              <p className="text-sm text-slate-500">
                {progress?.solvedQuestions?.length || 0} / {topic.practiceQuestions?.length || 0} Solved
              </p>
            </div>

            {topic.practiceQuestions && topic.practiceQuestions.length > 0 ? (
              <div className="space-y-3">
                {topic.practiceQuestions.map((question, idx) => {
                  const isSolved = progress?.solvedQuestions?.includes(question.slug);
                  
                  return (
                    <div 
                      key={question.slug || idx}
                      className={cn(
                        "group flex items-center justify-between p-4 rounded-xl border transition-all duration-200",
                        isSolved 
                          ? "bg-green-50/30 border-green-200 shadow-sm" 
                          : "bg-white border-slate-100 hover:border-blue-200 hover:shadow-md"
                      )}
                    >
                      <div className="flex items-center gap-4">
                        <button
                          onClick={() => onToggleQuestion(question.slug, question.link, question.name)}
                          className={cn(
                            "w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",
                            isSolved 
                              ? "bg-green-500 border-green-500 text-white" 
                              : "border-slate-300 text-transparent hover:border-blue-400"
                          )}
                        >
                          <CheckCircle size={14} fill="currentColor" className={isSolved ? "scale-100" : "scale-0"} />
                        </button>
                        
                        <div>
                          <div className={cn("font-medium transition-colors", isSolved ? "text-slate-500 line-through decoration-slate-400" : "text-slate-900")}>
                            {question.name}
                          </div>
                          <div className="flex gap-2 mt-1">
                            <Badge 
                              variant="secondary" 
                              className={cn(
                                "text-[10px] px-1.5 py-0 h-5 font-normal", 
                                question.difficulty === 'Easy' ? "bg-green-100 text-green-700" :
                                question.difficulty === 'Medium' ? "bg-amber-100 text-amber-700" :
                                "bg-red-100 text-red-700"
                              )}
                            >
                              {question.difficulty}
                            </Badge>
                          </div>
                        </div>
                      </div>

                      <a 
                        href={question.link} 
                        target="_blank" 
                        rel="noreferrer"
                        className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100"
                        title="Open Problem"
                      >
                        <ExternalLink size={18} />
                      </a>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-12 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                <Code className="h-10 w-10 mx-auto mb-2 opacity-50" />
                <p>No practice problems available.</p>
              </div>
            )}
          </TabsContent>

          {/* Notes Tab */}
          <TabsContent value="notes" className="mt-0 space-y-6 animate-in fade-in-50 slide-in-from-bottom-2 duration-300">
            <div className="flex items-center justify-between">
              <h3 className="text-xl font-semibold text-slate-900">Personal Notes</h3>
              <Button onClick={onSaveNotes} disabled={saving} size="sm">
                {saving ? "Saving..." : "Save Notes"}
              </Button>
            </div>
            
            <div className="min-h-[500px] border rounded-lg bg-white overflow-hidden">
               <MarkdownEditor
                 value={userNotes}
                 onChange={onNotesChange}
                 height={500}
               />
            </div>
            <p className="text-xs text-slate-400 text-right">
              Supports Markdown. Changes are not auto-saved (click Save).
            </p>
          </TabsContent>
        </div>
      </Tabs>
    </div>
  );
}

// Helper for Tab Triggers
function TabTriggerItem({ value, icon, label, count }: { value: string; icon: React.ReactNode; label: string; count?: number }) {
  return (
    <TabsTrigger 
      value={value} 
      className="data-[state=active]:bg-transparent data-[state=active]:shadow-none data-[state=active]:border-b-2 data-[state=active]:border-blue-600 data-[state=active]:text-blue-700 rounded-none border-b-2 border-transparent px-2 py-4 h-full gap-2 text-slate-500 hover:text-slate-800 transition-colors"
    >
      {icon}
      <span>{label}</span>
      {count !== undefined && count > 0 && (
         <span className="ml-1 text-xs py-0.5 px-1.5 bg-slate-100 text-slate-600 rounded-full">{count}</span>
      )}
    </TabsTrigger>
  );
}
